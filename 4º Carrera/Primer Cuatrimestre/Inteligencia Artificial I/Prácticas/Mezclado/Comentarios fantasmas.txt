Comentarios acerca de los fantasmas:

Los fantasmas tienen un comportamiento idéntico en determinadas situaciones, pero en otras se comportan de manera diferente:

- Pinky: Pinky es el fantasma más básico. Lo único que hace es ir a por MsPacman, pero se separa del resto de fantasmas si detecta que está detrás de otro. Esto lo realizamos comprobando que la distancia al fantasma más cercano (que será al primero que podamos pillar teniendo en cuenta que no podemos dar la vuelta) es menor a la distancia a MsPacman y además esta distancia es pequeña (de 15 turnos como mucho). El 15 puede parecer arbitrario, pero tras realizar pruebas hemos determinado que es una distancia que impide que Pinky adelante a otro fantasma en situaciones como 

	-------------------
	|    <-M   <-F	  |      - M representa a MsPacman.
	|   |---------|   |      - F representa a un fantasma que persigue a MsPacman.
	|   |         |   |      - P representa a Pinky.
	|   |---------|   |      - Las flechas representan la dirección de movimiento.
	|               P |

donde querríamos que Pinky siguiera hacia la izquierda, pero no lo hará porque el camino más corto a MsPacman es por arriba. La distancia 15 es suficiente para que en estas situaciones Pinky evite ir por el mismo camino que el otro fantasma, pero que si por ejemplo MsPacman ya estuviera más cerca de la esquina inferior izquierda Pinky vaya hacia la izquierda y le capture. Podría parecer que si el otro fantasma está muy lejos de MsPacman, este comportamiento no se ejecuta de esta manera, pero no es así, pues los fantasmas, al tener como comportamiento por defecto ir a por MsPacman, van adelantándose, de forma que el que se queda atrás comienza a separarse y a ir por otro camino. Es importante que esta separación solo se realiza si ninguno de los fantasmas son comestibles.

- Inky: Inky es muy parecido a Pinky, siendo la única diferencia el comportamiento cuando MsPacman se come una PowerPill y los fantasmas se vuelven vulnerables (estado edible). Inky es el único fantasma que en estas situaciones a veces se sacrificará por otro fantasma para intentar salvar a sus compañeros. Las reglas asociadas a este comportamiento son de la forma INKYseSacrificaPorX, que al volverse vulnerable intentará alejarse del fantasma más cercano, aunque eso conlleve morir. La principal ventaja es que al morir rápidamente, Inky enseguida reaparece y puede ir a por MsPacman, pudiendo tender trampas usando a compañeros como cebo si MsPacman está programado para priorizar comer a fantasmas aunque haya alguno vivo que no sea comestible. Por ejemplo, en la siguiente situación

	-------------------
	|    M->   F->    |      - M representa a MsPacman.
	|   |---------|   |      - F representa a un fantasma comestible.
	|   |         | I |      - I representa a Inky, que no es comestible.
	|   |---------|   |      - Las flechas representan la dirección de movimiento.
	|                 |

Inky, al haber muerto el primero, ya ha salido y puede ir a por MsPacman, que ha ido a comer a otro fantasma comestible y no se ha preocupado de que Inky ya esté yendo a por ella.

- Blinky: Blinky es el fantasma "perrito guardián", que lo único que hace es ir a la PowerPill más cercana a MsPacman y dar vueltas a su alrededor con la esperanza de ahuyentar a MsPacman. Puesto que Blinky no persigue a MsPacman si está en este modo, el resto de fantasmas lo ignoran y no lo tienen en cuenta a la hora de decidir si separarse o no. Solamente cuando no queda ninguna PowerPill es cuando Blinky se vuelve más agresivo y comienza a perseguir a MsPacman del mismo modo que los demás. Esto se puede ver en las reglas XsepararseBLINKY (en el resto de fantasmas) o en BLINKYsepararseX (en blinkyrules.clp), que solamente se activan si no el numero de PowerPills es 0. Originalmente, el que realizaba este papel no era Blinky, sino Inky. Sin embargo, nos dimos cuenta de que si la PowerPill que quedaba era una de arriba y MsPacman moría, si al reaparecer iba a por la PowerPill, Blinky (que intentaría perseguir a MsPacman) tomaba caminos subóptimos (desde el punto de vista de la macroestrategia, sí elegía el camino más corto para ir a por MsPacman) y permitía que MsPacman llegara a la PowerPill antes de que Inky (que sale de los últimos) pudiera defenderla. Por esta razón, intercambiamos el comportamiento de Inky y Blinky para que Blinky (que es el primero en salir) fuera directamente a la PowerPill que MsPacman estaba intentando alcanzar y la defendiera antes de que ella llegara, de forma que lograra ganar tiempo ahuyentándola y permitiera al resto de fantasmas salir. Puede parecer un cambio menor, pero más de una vez ha resultado ser decisivo.

- Sue: Sue es el fantasma estrella de nuestro equipo. Si el número de PowerPills restantes no es 1 (es decir, o quedan más de una o no queda ninguna), el comportamiento de Sue es idéntico al de Pinky, tratando de perseguir a MsPacman y separándose de los demás fantasmas perseguidores en caso de quedar por detrás. Sin embargo, cuando solo queda una única PowerPill, Sue comienza a protegerla junto a Blinky, y el resto de fantasmas comenzarán a ignorarla a la hora de separarse de ella. Esto es porque, si queda más de una PowerPill, Blinky se pasaba la mayor parte del tiempo yendo de una PowerPill a otra según cambiaba la que estuviera más cerca de MsPacman. Pero cuando solo queda una, esto no sucede. Por tanto, decidimos reforzar la seguridad de esa PowerPill añadiendo otro fantasma para protegerla y asegurarnos de que MsPacman tuviera muy difícil comérsela. De por sí sola, esta estrategia no sería tan impresionante, puesto que al final se podrían dar situaciones como

	-------------------
	|     <-S  <-B    |      - * representa una PowerPill.
	| * |---------|   |      - S representa a Sue.
	|   |         |   |      - B representa a Blinky.
	|   |---------|   |      - Las flechas representan la dirección de movimiento.
	|                 
        ---------------

en las que aún hay muchas probabilidades de que MsPacman pueda colarse y alcance la PowerPill. Lo que decidimos hacer fue que Sue y Blinky se movieran en sentidos contrarios, lo que dificulta en gran medida (y decir eso quizá sea un eufemismo) que MsPacman pueda completar el nivel, de modo que en la mayoría de casos MsPacman se quedará dando vueltas hasta que se le acabe el tiempo. Desgraciadamente, con las acciones e información que teníamos disponibles, parecía imposible conseguir que Sue se comportara de esta manera. Sin embargo, tras realizar cálculos con la distancia y tener en cuenta todas las situaciones posibles se nos ocurrió una idea que funciona en muchos casos (no funciona siempre, en el nivel 1 por ejemplo funciona si la última PowerPill es una de las de arriba, con las de abajo no es tan efectivo, y tras dar una vuelta a veces Sue se da un paseo antes de volver a defender la PowerPill). Describimos la implementación a continuación:

(defrule SUEdefiendePowerPill
	(SUE (edible false))
	(MSPACMAN (nearestPPill ?npp))
	(INFO (numberPPillsLeft 1))
	=>
	(assert (ACTION (id SUEmoveToPPill) (info "Queda 1 powerpill --> Defender powerpill") (powerPillNode ?npp)))
)

(defrule SUEpersigueBLINKY
	(declare (salience 15))
	(SUE (edible false) (distanceToPacmanNearestPPill ?d))
	(INFO (numberPPillsLeft 1))
	(BLINKY (edible false) (distanceNearestGhost ?dis) (distanceToPacmanNearestPPill ?dpp) (nearestGhost SUE))
	(test (> ?dpp ?dis)) (test (< ?d 45)) (test (> ?dis 0)) (test (> ?d 0)) (test (> ?dpp 0))
	=>
	(assert (ACTION (id SUEchaseGhost) (info "Queda 1 powerpill --> Defender powerpill") (ghost BLINKY)))
)

(defrule SUEseAlejaDeBLINKY
	(declare (salience 15))
	(SUE (edible false) (distanceToPacmanNearestPPill ?d))
	(INFO (numberPPillsLeft 1))
	(BLINKY (edible false) (distanceNearestGhost ?dis) (distanceToPacmanNearestPPill ?dpp) (nearestGhost SUE))
	(test (< ?dpp ?dis)) (test (< ?d 45)) (test (> ?d 0)) (test (> ?dpp 0)) (test (> ?dis 0))
	=>
	(assert (ACTION (id SUErunAwayFromGhost) (info "Queda 1 powerpill --> Defender powerpill") (ghost BLINKY)))
)

En primer lugar, hacemos notar que estas tres reglas solamente se activan si queda una única PowerPill y Sue no es comestible. Si se da esta situación:

- Sue intenta en primer lugar ir a defender la PowerPill restante, ese será su comportamiento por defecto, que hará que se acerque a la PowerPill de estar lejos.
- Cuando Sue está cerca de la PowerPill (a distancia menor que 45, este valor se explica debajo) y tiene que tomar una decisión acerca de adonde ir (idealmente está en la esquina opuesta a la PowerPill), mira las posiciones de Blinky y la PowerPill y activa una de las dos reglas con mayor prioridad:
 · Si la distancia de Blinky a Sue es menor que la distancia de Blinky a la PowerPill (medidas desde el punto de vista de Blinky), es porque Blinky, de seguir su camino, llegaría antes a Sue que a la PowerPill, por lo que nos interesa que Sue vaya hacia Blinky, ya que así tomará el camino opuesto a Blinky. Es decir, la situación es parecida a

	-------------------
	|       B->       |      - * representa una PowerPill.
	| * |---------|   |      - S representa a Sue.
	|   |         |   |      - B representa a Blinky.
	|   |---------|   |      - Las flechas representan la dirección de movimiento.
	|               S 
        ---------------

y queremos que Sue vaya hacia Blinky.
 · En caso contrario (es decir, la distancia de Blinky a la PowerPill es menor que la distancia a Sue), lo que sucede es que Blinky está en la zona de abajo a la izquierda (o la equivalente en otras PowerPills) y la posición es algo similar a

	-------------------
	|                 |      - * representa una PowerPill.
	| * |---------|   |      - S representa a Sue.
	|   |         |   |      - B representa a Blinky.
	|   |---------|   |      - Las flechas representan la dirección de movimiento.
	|     <-B       S 
        ---------------

y queremos que Sue vaya por arriba. La única manera de hacer que Sue fuera hacia arriba que se nos ocurrió fue hacer que se alejara de Blinky, que es justo lo que se hace en la regla. Por supuesto, hacer que Sue se quiera alejar de Blinky tiene sus consecuencias, y es por eso que si la última PowerPill es una de las de abajo, al tener más de una entrada a la esquina, a veces se alejará un poco antes de que la regla por defecto le obligue a volver.

¿Por qué 45?

A la hora de elegir el valor en cuestión, debíamos elegir un número que fuera suficientemente grande como para que la decisión de qué camino tomar se efectúe antes de entrar a la zona que rodea a la PowerPill, pero que no fuera tan grande como para que Sue pudiera querer alejarse de Blinky cuando aún no estaba cerca de la PowerPill. Tras hacer varias pruebas, observamos que el valor maximo de la distancia entre una PowerPill y la entrada más alejada a la zona que la rodea era de alrededor de 40, por lo que elegimos 45 para ir sobre seguro y sin pasarnos. Además, así le dábamos algo de tiempo para calcular la ruta que debía seguir.

Resumen:

En general, el comportamiento de los fantasmas estuvo muy pensado y logramos que mediante unas sencillas reglas de comportamiento (en su mayoría al menos) tuvieran un comportamiento excelente, coordinándose para atrapar a MsPacman desde varios caminos a la vez. Esto se reflejó después en el torneo de prueba que realizamos en clase, en el que nuestros fantasmas resultaron ser los mejores de todos con diferencia. Por ejemplo, nuestra MsPacman prácticamente nunca era capaz de llegar al nivel 2, y era una de las mejores de la clase. Estamos muy satisfechos con el resultado.